<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <!-- Title -->
  <title>Forced Labor</title>

  <!-- PWA manifest & Apple Touch Icon -->
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/forced-labor-icon-192.png" />

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #fff;
    }

    .forced-labor-app {
      max-width: 960px;
      margin: 0 auto;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 0.25rem;
    }

    .current-date {
      font-size: 0.95rem;
      color: #555;
      margin-bottom: 1rem;
    }

    /* Filter buttons layout */
    .filter-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1.2rem;
    }

    .filter-btn {
      border: 1px solid #ddd;
      padding: 0.45rem 0.9rem;
      border-radius: 999px;
      background: #f5f5f5;
      cursor: pointer;
      font-size: 0.92rem;
    }

    .filter-btn.active {
      background: #000;
      color: #fff;
      border-color: #000;
    }

    /* Chore card stack (vertical) and left-aligned */
    .chores-container {
      display: flex;
      flex-direction: column;
      gap: 0.9rem;
      width: min(640px, 100%);
      margin-left: 0;
      margin-right: auto;
    }

    .chore-card {
      border-radius: 0.85rem;
      padding: 1.1rem;
      background: #fafafa;
      border-left: 6px solid #ccc;
      box-shadow: 0px 3px 10px rgba(0, 0, 0, 0.06);
      font-size: 0.97rem;
    }

    .chore-kid {
      font-weight: 600;
      margin-bottom: 0.35rem;
    }

    .chore-daily,
    .chore-weekly {
      margin: 0.2rem 0;
    }

    .chore-date {
      margin-top: 0.6rem;
      font-size: 0.9rem;
      color: #777;
    }

    /* Kid-specific accent colors */
    .Emmitt { border-left-color: #2ecc71; }
    .Turner { border-left-color: #3498db; }
    .Miles  { border-left-color: #1abc9c; }
    .Stewart { border-left-color: #9b59b6; }
  </style>
</head>

<body>
<div class="forced-labor-app">
  <h1>Forced Labor</h1>
  <p id="chore-date" class="current-date"></p>

  <div class="filter-buttons">
    <button class="filter-btn active" data-kid="all">All</button>
    <button class="filter-btn" data-kid="Emmitt">Emmitt</button>
    <button class="filter-btn" data-kid="Turner">Turner</button>
    <button class="filter-btn" data-kid="Miles">Miles</button>
    <button class="filter-btn" data-kid="Stewart">Stewart</button>
  </div>

  <div id="chores-container" class="chores-container">
    <p class="loading">Loading chores from Google Sheetsâ€¦</p>
  </div>
</div>

<script>
  const sheetId = "1qQEGcKsi5SW6xiZZXkZbV5rY8x7Hs1ImXt8lIXN_uzE";
  const sheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json`;

  const choreDate = document.getElementById("chore-date");
  const choresContainer = document.getElementById("chores-container");
  const filterButtons = document.querySelectorAll(".filter-btn");

  // Show today's date under the title
  function updateDate() {
    const now = new Date();
    choreDate.textContent = now.toLocaleDateString("en-US", {
      weekday: "long",
      month: "short",
      day: "numeric",
      year: "numeric",
    });
  }
  updateDate();

  // Format whatever crazy thing Sheets gives us into mm/dd/yyyy
  function formatDisplayDate(raw) {
    if (!raw) return "";

    // If it's like "Date(2025,11,2)"
    if (typeof raw === "string" && raw.startsWith("Date(")) {
      const parts = raw.match(/\d+/g);
      if (parts && parts.length >= 3) {
        const y = Number(parts[0]);
        const m = Number(parts[1]); // already zero-based in that string
        const d = Number(parts[2]);
        const js = new Date(y, m, d);
        return js.toLocaleDateString("en-US");
      }
    }

    // If it's a Sheets serial number
    if (typeof raw === "number") {
      const ms = (raw - 25569) * 86400 * 1000;
      const js = new Date(ms);
      return js.toLocaleDateString("en-US");
    }

    // Already human-readable
    return String(raw);
  }

  // Parse the Google Sheets JSON
  function parseSheetResponse(text) {
    const jsonText = text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1);
    const obj = JSON.parse(jsonText);
    const rows = obj.table.rows || [];

    return rows.map(r => {
      const c = r.c || [];
      const dateCell = c[0];

      let rawDate = "";
      if (dateCell) {
        if (dateCell.f) {
          rawDate = dateCell.f;       // formatted string from Sheets
        } else {
          rawDate = dateCell.v;       // raw value
        }
      }

      return {
        date: formatDisplayDate(rawDate),
        kid: (c[1]?.v || "").trim(),
        dailyChore: c[2]?.v || "",
        weeklyChore: c[3]?.v || "",
        phone: c[4]?.v || "",
        todayFlag: ((c[5]?.v || "") + "").trim()
      };
    });
  }

  let visibleRows = [];

  function renderChores(kidFilter) {
    choresContainer.innerHTML = "";

    const rowsToShow =
      kidFilter === "all"
        ? visibleRows
        : visibleRows.filter(row => row.kid === kidFilter);

    if (!rowsToShow.length) {
      choresContainer.innerHTML =
        `<p>No rows are marked "Yes" in the Today column. Check the Google Sheet.</p>`;
      return;
    }

    rowsToShow.forEach(row => {
      const card = document.createElement("div");
      card.className = `chore-card ${row.kid}`;

      card.innerHTML = `
        <div class="chore-kid">${row.kid}</div>
        <div class="chore-daily"><strong>Daily:</strong> ${row.dailyChore}</div>
        <div class="chore-weekly"><strong>Weekly:</strong> ${row.weeklyChore}</div>
        <div class="chore-date">${row.date}</div>
      `;

      choresContainer.appendChild(card);
    });
  }

  function attachFilters() {
    filterButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelector(".filter-btn.active").classList.remove("active");
        btn.classList.add("active");
        const kid = btn.dataset.kid;
        renderChores(kid);
      });
    });
  }

  async function loadChores() {
    try {
      const res = await fetch(sheetUrl);
      const text = await res.text();
      const allRows = parseSheetResponse(text);

      // Only rows where Today column == "Yes"
      visibleRows = allRows.filter(
        row => row.todayFlag.toLowerCase() === "yes"
      );

      if (!visibleRows.length) {
        choresContainer.innerHTML =
          `<p>No rows are marked "Yes" in the Today column. Check the Google Sheet.</p>`;
        return;
      }

      renderChores("all");
    } catch (err) {
      console.error("Error loading sheet", err);
      choresContainer.innerHTML =
        `<p style="color:red;">Could not load chores from Google Sheets. Tell Dad to fix it.</p>`;
    }
  }

  attachFilters();
  loadChores();
</script>

</body>
</html>
