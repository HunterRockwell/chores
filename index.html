<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <title>Forced Labor</title>

  <style>
    :root {
      --bg: #f5f5f7;
      --card-bg: #ffffff;
      --text-main: #111;
      --text-muted: #666;
      --accent: #007aff;
      --danger: #cc0000;
      --radius: 18px;
      --shadow: 0 14px 30px rgba(0,0,0,0.06);
    }

    body {
      margin: 0;
      background: var(--bg);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      color: var(--text-main);
    }

    .app {
      max-width: 640px;
      margin: 0 auto;
      padding: 1.2rem 1.3rem 2.5rem;
    }

    h1 {
      font-size: 2rem;
      margin: 0 0 0.25rem;
      font-weight: 700;
    }

    .date {
      font-size: 0.95rem;
      color: var(--text-muted);
      margin-bottom: 0.8rem;
    }

    .chores {
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 0.9rem 1.1rem;
    }

    .kid {
      font-weight: 650;
      font-size: 1.05rem;
      margin-bottom: 0.2rem;
    }

    .line {
      font-size: 0.97rem;
    }

    .label {
      font-weight: 700;
    }

    .nav {
      margin-top: 1rem;
      font-size: 0.9rem;
    }

    .nav a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
    }

    .nav a:hover {
      text-decoration: underline;
    }

    .message-wrap {
      margin-top: 1.2rem;
      display: none;
    }

    .divider {
      height: 1px;
      background: rgba(0,0,0,0.12);
      margin: 0.8rem 0;
    }

    .message-title {
      font-weight: 800;
      font-size: 1.05rem;
      margin-bottom: 0.2rem;
    }

    .message-text {
      font-style: italic;
      font-size: 0.96rem;
      line-height: 1.35;
      color: rgba(0,0,0,0.75);
    }

    .trash {
      color: var(--danger);
      font-weight: 900;
      font-size: 1.25rem;
      letter-spacing: 0.04em;
      white-space: nowrap;
    }
  </style>
</head>

<body>
<div class="app">
  <h1>Forced Labor</h1>
  <div id="date" class="date"></div>

  <div id="chores" class="chores"></div>

  <div class="nav">
    <a id="prev" href="#">‚Üê Previous Day</a>
    &nbsp;|&nbsp;
    <a id="next" href="#">Next Day ‚Üí</a>
    <span id="todayWrap" style="display:none;">
      &nbsp;|&nbsp;<a href="index.html">Back to Today</a>
    </span>
  </div>

  <div id="messageWrap" class="message-wrap">
    <div class="divider"></div>
    <div id="message"></div>
  </div>
</div>

<script>
(() => {
  const SHEET_ID = "1qQEGcKsi5SW6xiZZXkZbV5rY8x7Hs1ImXt8lIXN_uzE";
  const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

  const choresEl = document.getElementById("chores");
  const dateEl = document.getElementById("date");
  const messageWrap = document.getElementById("messageWrap");
  const messageEl = document.getElementById("message");

  const params = new URLSearchParams(location.search);
  const offset = parseInt(params.get("offset") || "0", 10);

  const now = new Date(
    new Date().toLocaleString("en-US", { timeZone: "America/Los_Angeles" })
  );
  now.setHours(0,0,0,0);
  now.setDate(now.getDate() + offset);

  const weekday = now.getDay(); // 4 = Thursday
  const ymd = now.toISOString().slice(0,10);

  dateEl.textContent = now.toLocaleDateString("en-US", {
    weekday: "long", month: "short", day: "numeric", year: "numeric"
  });

  document.getElementById("prev").href = `?offset=${offset-1}`;
  document.getElementById("next").href = `?offset=${offset+1}`;
  document.getElementById("todayWrap").style.display = offset !== 0 ? "inline" : "none";

  fetch(URL)
    .then(r => r.text())
    .then(txt => {
      const json = JSON.parse(txt.substring(txt.indexOf("{"), txt.lastIndexOf("}")+1));
      const rows = json.table.rows || [];

      rows.forEach(r => {
        const d = r.c[0]?.v;
        if (!d) return;

        const m = d.match(/Date\((\d+),(\d+),(\d+)\)/);
        if (!m) return;

        const rowDate = new Date(m[1], m[2], m[3]);
        rowDate.setHours(0,0,0,0);

        if (rowDate.getTime() !== now.getTime()) return;

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="kid">${r.c[1]?.v}</div>
          <div class="line"><span class="label">Daily:</span> ${r.c[2]?.v}</div>
          <div class="line"><span class="label">Weekly:</span> ${r.c[3]?.v}</div>
        `;
        choresEl.appendChild(card);
      });
    });

  // MESSAGE LOGIC
  messageWrap.style.display = "block";

  if (weekday === 4) {
    messageEl.innerHTML = `<div class="trash">TAKE TRASH TO ROAD</div>`;
    return;
  }

  fetch(`daily/${ymd}.json`, { cache: "no-store" })
    .then(r => r.ok ? r.json() : null)
    .then(d => {
      if (!d) {
        messageEl.innerHTML = `
          <div class="message-title">üí≠ No wisdom today.</div>
          <div class="message-text">That is the lesson.</div>`;
        return;
      }

      messageEl.innerHTML = `
        <div class="message-title">üí° ${d.title}</div>
        <div class="message-text">${d.message}</div>`;
    });
})();
</script>
</body>
</html>
