<div class="forced-labor-app">
  <h1>Forced Labor</h1>
  <p id="chore-date" class="current-date"></p>

  <div class="filter-buttons">
    <button class="filter-btn active" data-kid="all">All</button>
    <button class="filter-btn" data-kid="Emmitt">Emmitt</button>
    <button class="filter-btn" data-kid="Turner">Turner</button>
    <button class="filter-btn" data-kid="Miles">Miles</button>
    <button class="filter-btn" data-kid="Stewart">Stewart</button>
  </div>

  <div id="chores-container" class="chores-container">
    <p class="loading">Loading chores from Google Sheets…</p>
  </div>
</div>

<style>
  .forced-labor-app {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    max-width: 900px;
    margin: 0 auto;
    padding: 1.5rem;
  }

  .forced-labor-app h1 {
    font-size: 2rem;
    margin-bottom: 0.25rem;
  }

  .current-date {
    font-size: 0.95rem;
    color: #555;
    margin-bottom: 1rem;
  }

  .filter-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .filter-btn {
    border: 1px solid #ddd;
    padding: 0.4rem 0.8rem;
    border-radius: 999px;
    background: #f5f5f5;
    cursor: pointer;
    font-size: 0.9rem;
  }

  .filter-btn.active {
    background: #222;
    color: #fff;
    border-color: #222;
  }

  /* STACK CARDS VERTICALLY */
  .chores-container {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    max-width: 520px;
    margin: 0 auto;
  }

  .chore-card {
    border-radius: 0.75rem;
    padding: 0.85rem 1rem;
    background: #fafafa;
    border-left: 5px solid #ccc;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
  }

  .chore-kid {
    font-weight: 600;
    margin-bottom: 0.35rem;
  }

  .chore-daily,
  .chore-weekly {
    font-size: 0.9rem;
    margin: 0.15rem 0;
  }

  .chore-label {
    font-weight: 600;
  }

  .chore-date {
    font-size: 0.75rem;
    color: #777;
    margin-top: 0.35rem;
  }

  .loading,
  .empty-state,
  .error-state {
    font-size: 0.95rem;
    color: #666;
  }

  .error-state {
    color: #b00020;
  }

  /* Color accents by kid */
  .kid-Emmitt {
    border-left-color: #22c55e; /* green */
  }
  .kid-Turner {
    border-left-color: #3b82f6; /* blue */
  }
  .kid-Miles {
    border-left-color: #14b8a6; /* teal */
  }
  .kid-Stewart {
    border-left-color: #a855f7; /* purple */
  }
</style>

<script>
  (function () {
    // KEEP YOUR REAL SHEET ID HERE
    const SHEET_ID = "1qQEGcKsi5SW6xiZZXkZbV5rY8x7Hs1ImXt8lIXN_uzE";
    const SHEET_NAME = "Chores";

    const choresContainer = document.getElementById("chores-container");
    const filterButtons = document.querySelectorAll(".filter-btn");
    const dateEl = document.getElementById("chore-date");
    let todaysChores = [];

    // Set today's date under the title
    const now = new Date();
    const dateOptions = {
      weekday: "long",
      month: "short",
      day: "numeric",
      year: "numeric"
    };
    dateEl.textContent = now.toLocaleDateString(undefined, dateOptions);

    const sheetUrl =
      "https://docs.google.com/spreadsheets/d/" +
      SHEET_ID +
      "/gviz/tq?sheet=" +
      encodeURIComponent(SHEET_NAME);

    function setLoading(message) {
      choresContainer.innerHTML = '<p class="loading">' + message + "</p>";
    }

    function setError(message) {
      choresContainer.innerHTML = '<p class="error-state">' + message + "</p>";
    }

    function renderChores(filterKid) {
      const kidFilter = filterKid || "all";
      let data = todaysChores;

      if (kidFilter !== "all") {
        data = data.filter(row => row.kid === kidFilter);
      }

      if (!data.length) {
        choresContainer.innerHTML =
          '<p class="empty-state">No chores found for this selection. Either Dad messed up the sheet or it\'s a free day.</p>';
        return;
      }

      const cardsHtml = data
        .map(row => {
          const kidClass = "kid-" + row.kid.replace(/\s+/g, "");
          return `
            <div class="chore-card ${kidClass}">
              <div class="chore-kid">${row.kid}</div>
              <div class="chore-daily">
                <span class="chore-label">Daily:</span> ${row.dailyChore || "—"}
              </div>
              <div class="chore-weekly">
                <span class="chore-label">Weekly:</span> ${row.weeklyChore || "—"}
              </div>
              <div class="chore-date">${row.date}</div>
            </div>
          `;
        })
        .join("");

      choresContainer.innerHTML = cardsHtml;
    }

    function attachFilters() {
      filterButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          filterButtons.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          const kid = btn.getAttribute("data-kid");
          renderChores(kid);
        });
      });
    }

    function parseSheetResponse(text) {
      const jsonText = text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1);
      const obj = JSON.parse(jsonText);

      const rows = obj.table.rows || [];
      return rows.map(r => {
        const c = r.c || [];
        return {
          date: c[0]?.f || c[0]?.v || "",
          kid: c[1]?.v || "",
          dailyChore: c[2]?.v || "",
          weeklyChore: c[3]?.v || "",
          phone: c[4]?.v || "",
          todayFlag: (c[5]?.v || "").toString().trim()
        };
      });
    }

    async function loadChores() {
      try {
        setLoading("Loading chores from the spreadsheet…");
        const res = await fetch(sheetUrl);
        const text = await res.text();

        const allRows = parseSheetResponse(text);

        // Only rows where Today column = "Yes"
        todaysChores = allRows.filter(
          row => row.todayFlag.toLowerCase() === "yes"
        );

        if (!todaysChores.length) {
          choresContainer.innerHTML =
            '<p class="empty-state">No rows are marked "Yes" in the Today column. Check the Google Sheet.</p>';
          return;
        }

        renderChores("all");
      } catch (err) {
        console.error("Error loading sheet", err);
        setError("Could not load chores from Google Sheets. Tell Dad to fix it.");
      }
    }

    attachFilters();
    loadChores();
  })();
</script>
